<!DOCTYPE html>
<html lang="lv">
<head>
<meta charset="UTF-8">
<title> binKods </title>
<style>
   .laukums {
    display: table;
    border-collapse: collapse;
  }
  .rinda{
    display: table-row;
  }

  .skaitlis {
    display: table-cell;
    background-color:green;
    border: 1px solid #333333;
    text-align:center;
    vertical-align:middle;
    height: 80px;
    width: 80px;
  }
  
  .laiks, .punkti {
    font-weight: bold;
  }
 </style>
 </head>
 <body id="spele" onload="sakums();">
 <script>
    let bin=["100","101","110","111","000","001","010","011"];
    let dec=[-4,-3,-2,-1,0,1,2,3];
    let saraksts=[];
    let cikKl=0;
    let pirmais,otrais;
    let atlauts=true;
    let laiks = 200; // cik ilgi notiks spēle
    let punkti = 0;
    function izveido(){
         for(let i=0;i<bin.length;i++){
            saraksts.push(bin[i]);
            saraksts.push(dec[i]);
        }
    }
    function sajauc(){
        for(let i=0;i<10;i++){
            let x=Math.floor(16*Math.random());
            saraksts.push(saraksts[x]);
            saraksts.splice(x,1);
        }
    }
    function parada(){
        let divs = document.createElement("DIV"); divs.className="laukums";
        for(let i=0;i<4;i++){
            let divR = document.createElement("DIV"); divR.className="rinda";
            for(let j=0;j<4;j++){
                let divK = document.createElement("DIV");
                let sk = document.createElement("IMG");
                sk.src="b"+saraksts[i*4+j]+".jpg";
                sk.style.display="none";
                divK.className="skaitlis";
                divK.appendChild(sk);
                divK.addEventListener("click",klik);
                function klik(){
                    if(atlauts && laiks>= 0)paraditSkaitli(sk);
                }
                divR.appendChild(divK);
            }
            divs.appendChild(divR);
        }   
        document.getElementById("spele").appendChild(divs);
        
        // pievieno laika atskaiti uz ekrāna
        let pLaiks = document.createElement("p");
        pLaiks.id = "idLaiks";
        pLaiks.className="laiks";
        pLaiks.innerText = "Laiks:" + laiks;
        document.getElementById("spele").appendChild(pLaiks);

        // pievieno punktus uz ekrāna
        let pPunkti = document.createElement("p");
        pPunkti.id = "idPunkti";
        pPunkti.className="punkti";
        pPunkti.innerText = "Punkti:" + punkti;
        document.getElementById("spele").appendChild(pPunkti);
    }
    function pieskaitaPunktu() {
        punkti = punkti+1;
        if( punkti < 8 ) {
            document.getElementById("idPunkti").innerText = "Punkti:" + punkti;
        } else {
            document.getElementById("idPunkti").innerText = "Uzvara!";
            setTimeout(()=>{
                let vards=prompt("Ievadi savu vardu!");
                s={"vards":vards,"punkti":laiks};
                dabutRezultatuTabulu(s, paraditRezultatuTabulu);
            },0);
         
        }
    }
    function paraditRezultatuTabulu(rez){
        let saraksts=document.createElement("OL");
        for (var r in rez){
        let viens=document.createElement("LI");
        viens.innerHTML=rez[r]["vards"]+" "+rez[r]["punkti"];
        saraksts.appendChild(viens);
        }
        document.getElementById("spele").appendChild(saraksts);
    }
  function dabutRezultatuTabulu(s, fnKadTabulaDabuta){
      console.log(s);
    var urla = new URL("http://127.0.0.1:5000/api/rezultati");
    Object.keys(s).forEach(key => urla.searchParams.append(key,s[key]))
    fetch(new Request(urla))
      .then((resp)=>resp.json())
      .then((data)=>{
        console.log(data.rezultati);
        fnKadTabulaDabuta(data.rezultati);
      });
  }
  function paraditSkaitli(sk){
        sk.style.display="block";
        if(cikKl%2==0){
            pirmais=sk;
        }else{
            otrais=sk;
            if(parbauda(pirmais,otrais)){
                otrais.style.display="block";
                pieskaitaPunktu();           
            }else{
                atlauts=false;
                setTimeout(function(){
                    pirmais.style.display="none";
                    otrais.style.display="none";
                    atlauts=true;
                    },1000);
                }
        }
        cikKl++;
    }
    function parbauda(p,o){
        let xs=p.getAttribute("src");
        console.log(xs)
        let x=xs.substring(xs.indexOf("b")+1,xs.indexOf(".")); 
        let ys=o.getAttribute("src");
        let y=ys.substring(ys.indexOf("b")+1,ys.indexOf("."));
        if(y.length==3&&x.length!=3&&bin[Number(x)+4]==y){
            return true;
        }else if(x.length==3&&y.length!=3&&bin[Number(y)+4]==x){
            return true;
        }
        return false;
    }
    
    function taimeris() {
        laiks--;
        if( laiks >= 0 ) {
            document.getElementById("idLaiks").innerText = "Laiks:" + laiks;
            if( punkti < 8 ) {
                setTimeout( taimeris, 1000 );
            }
        } else {
            document.getElementById("idLaiks").innerText = "Laiks beidzies";
        }
    }

    function sakums(){
        izveido();
        sajauc();
        parada();
        setTimeout( taimeris, 1000 );
    }
</script>
</body>
</html>
